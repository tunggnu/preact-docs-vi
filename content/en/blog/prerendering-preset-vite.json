{"meta":{"title":"Prerendering with `@preact/preset-vite`","date":"2024-08-06","authors":["Ryan Christian"]},"html":"<h1>Prerendering with Preset Vite</h1><p>It&#39;s been a half-year since our prerendering plugin has somewhat quietly become available in <code>@preact/preset-vite</code>, so let&#39;s talk about it, a little of our history, and the ecosystem at large.</p>\n<p>Those who have been in our community for a while know how much we like prerendering; it was a first-class feature in Preact-CLI, then WMR, and now our Vite preset. When it&#39;s done right, it&#39;s a pain-free addition to the typical SPA that improves the user experience greatly and our prerender-plugin aims to facilitate just that.</p>\n\n\t\t\t\t<h2 id=\"what-is-prerendering?\">\n\t\t\t\t\t<a class=\"fragment-link\" href=\"#what-is-prerendering?\">\n\t\t\t\t\t\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" aria-label=\"Link to: What is Prerendering? (#what-is-prerendering?)\">\n\t\t\t\t\t\t\t<use href=\"/icons.svg#link\" ></use>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</a>\n\t\t\t\t\t<span>What is Prerendering?</span>\n\t\t\t\t</h2><p>&quot;Prerendering&quot;, for the context of this post, is the act of generating HTML from your app at build time using server-side rendering (SSR); sometimes this may also be referred to as static site generation (SSG).</p>\n<p>While we won&#39;t dive deep into the virtues of SSR here, or even argue that you should use it, it&#39;s generally advantageous to send a fully populated HTML document to the user on initial navigation (and perhaps upon subsequent navigations too, depending on routing strategy) rather than an empty shell that the client-side JS will eventually render into. Users will get access to the document quicker and can begin to use the page (albeit, often with reduced functionality) while the JS is still downloading in the background.</p>\n\n\t\t\t\t<h2 id=\"our-history-in-the-space\">\n\t\t\t\t\t<a class=\"fragment-link\" href=\"#our-history-in-the-space\">\n\t\t\t\t\t\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" aria-label=\"Link to: Our History in the Space (#our-history-in-the-space)\">\n\t\t\t\t\t\t\t<use href=\"/icons.svg#link\" ></use>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</a>\n\t\t\t\t\t<span>Our History in the Space</span>\n\t\t\t\t</h2><p>Since Preact-CLI first hit public release back in May of 2017, built-in prerendering has been a mainstay in our build tooling; we happily carried it forward into WMR in 2020 and it was something that was sorely missed by us and members of the community when we switched to suggesting Vite.</p>\n<p>While each iteration has been a little different, all have been built around the same core idea: users will more readily adopt prerendering the simpler it is to set up, including limited changes to their existing codebase. In Preact-CLI, this meant providing a default export of the root component with some JSON data to populate it; in WMR and now Vite, it means exporting a simple <code>prerender()</code> function that returns the HTML for the route, with the prerenderer walking through the app itself, replacing the need for JSON up-front.</p>\n<p>Anyone who has worked extensively with SSR at scale knows that there is a mountain of complexity that cannot ever be fully abstracted away and we wouldn&#39;t argue otherwise. However, nearly every SPA provides a better experience if prerendered and so we want to get as many users as possible on board -- reducing the barrier to entry has shown itself to be wildly successful in our community so it&#39;s been a key part of our design philosophy to aim for as &quot;drop-in&quot; as possible.</p>\n\n\t\t\t\t<h2 id=\"existing-vite-ecosystem\">\n\t\t\t\t\t<a class=\"fragment-link\" href=\"#existing-vite-ecosystem\">\n\t\t\t\t\t\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" aria-label=\"Link to: Existing Vite Ecosystem (#existing-vite-ecosystem)\">\n\t\t\t\t\t\t\t<use href=\"/icons.svg#link\" ></use>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</a>\n\t\t\t\t\t<span>Existing Vite Ecosystem</span>\n\t\t\t\t</h2><p>Before we created our own prerendering implementation for our Vite preset, we had a look at the existing Vite ecosystem to see what was being offered but didn&#39;t quite find what we were after with the options. Prerendering is at its best when it is as near to &quot;drop-in&quot; as possible, taking your existing app, with minimal modification, and generating HTML from it, but existing solutions were a further step away from &quot;drop-in&quot; than we would&#39;ve liked and fell into two main categories:</p>\n<ol>\n<li>Multiple Builds<ul>\n<li>Separate client/server builds, often separate entry points too</li>\n<li>Less isomorphic, different branches in your app for different environments</li>\n</ul>\n</li>\n<li>Frameworks / Vite Wrappers<ul>\n<li>No longer using Vite directly but an abstraction</li>\n<li>Some amount of buy-in/lock-in</li>\n<li>Support matrix for different Vite config options, plugins, etc. can be complicated and less than clear</li>\n</ul>\n</li>\n</ol>\n<p>While these solutions absolutely have their merits and places in the ecosystem, neither felt as great as they could be for our ecosystem, given our historic offerings in this area. The &quot;best case scenario&quot; DX was often sacrificed for more complex or specific needs -- which is a completely valid trade off.</p>\n<p>For drop-in prerendering, however, we thought we could provide something a bit different to the existing options, or at least something a bit more familiar to our users.</p>\n\n\t\t\t\t<h2 id=\"implementation-in-@preactpreset-vite\">\n\t\t\t\t\t<a class=\"fragment-link\" href=\"#implementation-in-@preactpreset-vite\">\n\t\t\t\t\t\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" aria-label=\"Link to: Implementation in `@preact/preset-vite` (#implementation-in-@preactpreset-vite)\">\n\t\t\t\t\t\t\t<use href=\"/icons.svg#link\" ></use>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</a>\n\t\t\t\t\t<span>Implementation in `@preact/preset-vite`</span>\n\t\t\t\t</h2><p>Years later, we were still quite in love with the simplicity and extensibility of WMR&#39;s prerendering and felt it was sorely missing from our Vite preset, so we looked to port it over with a few minor adjustment to fix the qualms we had. A little bit of work later and voila, prerendering via a plugin!</p>\n<p>To get started with, here&#39;s an example of prerendering a &quot;Hello World&quot; app.</p>\n<blockquote>\n<p>Hint: Our Vite initializer, (<code>$ npm create preact</code>) can set this up for you along with a few other complimentary options, like routing, TypeScript, etc. If you&#39;re interested in trying out our prerendering, it&#39;s the fastest way to get up-to-speed.</p>\n</blockquote>\n<p>Firstly, enable prerendering by setting <code>prerender: { enabled: true }</code> in <code>@preact/preset-vite</code>&#39;s plugin options:</p>\n\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-diff\">// vite.config.js\nimport { defineConfig } from 'vite';\nimport preact from '@preact/preset-vite';\n\n// https://vitejs.dev/config/\nexport default defineConfig({\n\tplugins: [\n\t\tpreact({\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\tprerender: { enabled: true }\n</span></span>\t\t}),\n\t],\n});</code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t<p>...then add a <code>prerender</code> attribute to the script containing our <code>prerender()</code> function -- this lets the plugin know where to find it. While you can set this to any script you&#39;d like, for our examples here, it&#39;ll always be in our app root.</p>\n\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-diff\">// index.html\n<span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">&lt;script type=\"module\" src=\"/src/index.jsx\">&lt;/script>\n</span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">&lt;script prerender type=\"module\" src=\"/src/index.jsx\">&lt;/script></span></span></code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t<p>...finally, make a couple adjustments to our app root:</p>\n<ol>\n<li><p>Switch <code>render</code> to <code>hydrate</code></p>\n<ul>\n<li><code>hydrate</code> from <code>preact-iso</code> is a very small utility which decides whether to render the app or hydrate depending on if it can find existing markup on the document. In dev it&#39;ll use <code>render</code>, but in production, with prerendered HTML, it&#39;ll use <code>hydrate</code>.</li>\n<li>We do need to add a window check (<code>typeof window !== undefined</code>) to ensure we&#39;re not trying to access <code>document</code>, a browser global, in Node during SSR.</li>\n</ul>\n</li>\n<li><p>Add our <code>prerender()</code> export</p>\n<ul>\n<li>This is the facilitator of prerendering, and it&#39;s entirely user controlled. You decide how your app should be rendered, which props to pass in to your root component, make any adjustments to the HTML, run any post-processing you&#39;d like, etc. All that the plugin needs is for an object to be returned containing an <code>html</code> property with your HTML string.</li>\n<li>For our examples here we&#39;ll use <code>prerender</code> from <code>preact-iso</code> which is a thin wrapper around <code>renderToStringAsync</code> from <code>preact-render-to-string</code> with one main advantage: it automatically collects and returns the relative links it finds in the pages you prerender. The prerender plugin can then use these links to &quot;walk&quot; your app, discovering pages itself. We&#39;ll show this off further later.</li>\n</ul>\n</li>\n</ol>\n\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-diff\">// src/index.jsx\n<span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">import { render } from 'preact';\n</span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">import { hydrate, prerender as ssr } from 'preact-iso';\n</span></span>\nfunction App() {\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   return &lt;h1>Hello World!&lt;/h1>\n</span></span>}\n\n<span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">render(&lt;App />, document.getElementById('app'));\n</span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">if (typeof window !== 'undefined') {\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\thydrate(&lt;App />, document.getElementById('app'));\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\">}\n</span></span>\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">export async function prerender(data) {\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\">    return await ssr(&lt;App {...data} />)\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\">}</span></span></code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t<p>With this set up, you will have an app that prerenders. However, no app is really this simple, so let&#39;s look at a couple more complex examples.</p>\n\n\t\t\t\t<h3 id=\"full-api-example\">\n\t\t\t\t\t<a class=\"fragment-link\" href=\"#full-api-example\">\n\t\t\t\t\t\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" aria-label=\"Link to: Full API Example (#full-api-example)\">\n\t\t\t\t\t\t\t<use href=\"/icons.svg#link\" ></use>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</a>\n\t\t\t\t\t<span>Full API Example</span>\n\t\t\t\t</h3>\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-jsx\"><span class=\"token comment\">// src/index.jsx</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">prerender</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> html<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">links</span><span class=\"token operator\">:</span> discoveredLinks <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">ssr</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n\t\thtml<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token comment\">// Optionally add additional links that should be</span>\n\t\t<span class=\"token comment\">// prerendered (if they haven't already been -- these will be deduped)</span>\n\t\t<span class=\"token literal-property property\">links</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>discoveredLinks<span class=\"token punctuation\">,</span> <span class=\"token string\">'/foo'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/bar'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token comment\">// Optionally configure and add elements to the `&lt;head>` of</span>\n\t\t<span class=\"token comment\">// the prerendered HTML document</span>\n\t\t<span class=\"token literal-property property\">head</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">// Sets the \"lang\" attribute: `&lt;html lang=\"en\">`</span>\n\t\t\t<span class=\"token literal-property property\">lang</span><span class=\"token operator\">:</span> <span class=\"token string\">'en'</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">// Sets the title for the current page: `&lt;title>My cool page&lt;/title>`</span>\n\t\t\t<span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> <span class=\"token string\">'My cool page'</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token comment\">// Sets any additional elements you want injected into the `&lt;head>`:</span>\n\t\t\t<span class=\"token comment\">//   &lt;link rel=\"stylesheet\" href=\"foo.css\"></span>\n\t\t\t<span class=\"token comment\">//   &lt;meta property=\"og:title\" content=\"Social media title\"></span>\n\t\t\t<span class=\"token literal-property property\">elements</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n\t\t\t\t<span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'link'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">rel</span><span class=\"token operator\">:</span> <span class=\"token string\">'stylesheet'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">href</span><span class=\"token operator\">:</span> <span class=\"token string\">'foo.css'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'meta'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">property</span><span class=\"token operator\">:</span> <span class=\"token string\">'og:title'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> <span class=\"token string\">'Social media title'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t\n\t\t\t\t<h3 id=\"fetch-content-isomorphically-with-suspense-based-fetching\">\n\t\t\t\t\t<a class=\"fragment-link\" href=\"#fetch-content-isomorphically-with-suspense-based-fetching\">\n\t\t\t\t\t\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" aria-label=\"Link to: Fetch Content Isomorphically with Suspense-based Fetching (#fetch-content-isomorphically-with-suspense-based-fetching)\">\n\t\t\t\t\t\t\t<use href=\"/icons.svg#link\" ></use>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</a>\n\t\t\t\t\t<span>Fetch Content Isomorphically with Suspense-based Fetching</span>\n\t\t\t\t</h3>\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-jsx\"><span class=\"token comment\">// src/use-fetch.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"preact/hooks\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> cache <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>ok<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Failed to fetch </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">!</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Simple suspense-based fetch mechanism with caching</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">useFetch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>_<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tdata <span class=\"token operator\">=</span> <span class=\"token function\">load</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tcache<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tdata<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n\t\t\t<span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>res <span class=\"token operator\">=</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>err <span class=\"token operator\">=</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> data<span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">throw</span> data<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-jsx\"><span class=\"token comment\">// src/index.jsx</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> hydrate<span class=\"token punctuation\">,</span> prerender <span class=\"token keyword\">as</span> ssr <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'preact-iso'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useFetch <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./use-fetch.js'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Suspense</span></span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n                </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Article</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Suspense</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Article</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token function\">useFetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/my-local-article.txt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> window <span class=\"token operator\">!==</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">hydrate</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">prerender</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token function\">ssr</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>data<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t\n\t\t\t\t<h3 id=\"using-globalthis-to-pass-data-around\">\n\t\t\t\t\t<a class=\"fragment-link\" href=\"#using-globalthis-to-pass-data-around\">\n\t\t\t\t\t\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" aria-label=\"Link to: Using `globalThis` to pass data around (#using-globalthis-to-pass-data-around)\">\n\t\t\t\t\t\t\t<use href=\"/icons.svg#link\" ></use>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</a>\n\t\t\t\t\t<span>Using `globalThis` to pass data around</span>\n\t\t\t\t</h3>\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-js\"><span class=\"token comment\">// src/title-util.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useEffect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'preact/hooks'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * Set `document.title` or `globalThis.title`\n * @param {string} title\n */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">useTitle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">title</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> window <span class=\"token operator\">===</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tglobalThis<span class=\"token punctuation\">.</span>title <span class=\"token operator\">=</span> <span class=\"token function\">createTitle</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tdocument<span class=\"token punctuation\">.</span>title <span class=\"token operator\">=</span> <span class=\"token function\">createTitle</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>title<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-jsx\"><span class=\"token comment\">// src/index.jsx</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> LocationProvider<span class=\"token punctuation\">,</span> Router<span class=\"token punctuation\">,</span> hydrate<span class=\"token punctuation\">,</span> prerender <span class=\"token keyword\">as</span> ssr <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'preact-iso'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useTitle <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./title-util.js'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LocationProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>main</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n                </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Home</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n                </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">NotFound</span></span> <span class=\"token attr-name\">default</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>main</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">LocationProvider</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">useTitle</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Preact - Home'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hello World!</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">NotFound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">useTitle</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Preact - 404'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Page Not Found</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> window <span class=\"token operator\">!==</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">hydrate</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">prerender</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> html<span class=\"token punctuation\">,</span> links <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">ssr</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>data<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        html<span class=\"token punctuation\">,</span>\n        links<span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">head</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> globalThis<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">elements</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'meta'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">property</span><span class=\"token operator\">:</span> <span class=\"token string\">'og:title'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> globalThis<span class=\"token punctuation\">.</span>title <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t<p>While less common of a need, you can also use a variation of this pattern to initialize and pass prerender data deep into your app, skipping the need for a global store/context.</p>\n\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-jsx\"><span class=\"token comment\">// src/some/deep/Component.jsx</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">MyComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> myFetchData <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>myData<span class=\"token punctuation\">,</span> setMyData<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>myFetchData <span class=\"token operator\">||</span> <span class=\"token string\">'some-fallback'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-js\"><span class=\"token keyword\">let</span> initialized <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">prerender</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">init</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>ok<span class=\"token punctuation\">)</span> globalThis<span class=\"token punctuation\">.</span>myFetchData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        initialized <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>initialized<span class=\"token punctuation\">)</span> <span class=\"token keyword\">await</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> html<span class=\"token punctuation\">,</span> links <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">ssr</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>App <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>data<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t<hr>\n<p>For the curious asking &quot;How does this all work?&quot;, it can be broken into three simple steps:</p>\n<ol>\n<li><p>Setup</p>\n<p> We set the script with your exported <code>prerender()</code> function as an additional input and tell Rollup to preserve entry signatures, allowing us to access and call that function post-build.</p>\n</li>\n<li><p>Build</p>\n<p> We let Vite build your app as usual: compiling JSX, running plugins, optimizing assets, etc.</p>\n</li>\n<li><p>Prerender</p>\n</li>\n</ol>\n<p>  During the <code>generateBundle</code> plugin stage, we begin to generate the HTML. Starting with <code>/</code>, we begin executing the built JS bundles in Node, calling your <code>prerender()</code> function and inserting the HTML it returns into your <code>index.html</code> document, finally writing the result to the specified output directory. Any new links your <code>prerender()</code> function returns are then queued up to be processed next.</p>\n<p>  Prerendering completes when we run out of URLs to feed back into your app.</p>\n<p>Following this, Vite will continue to finish up the build process, running any other plugins you may have. Your prerendered app will then be available immediately, with no subsequent builds or scripts required.</p>\n\n\t\t\t\t<h3 id=\"some-neat-features\">\n\t\t\t\t\t<a class=\"fragment-link\" href=\"#some-neat-features\">\n\t\t\t\t\t\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" aria-label=\"Link to: Some Neat Features (#some-neat-features)\">\n\t\t\t\t\t\t\t<use href=\"/icons.svg#link\" ></use>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</a>\n\t\t\t\t\t<span>Some Neat Features</span>\n\t\t\t\t</h3><ul>\n<li>File system-based <code>fetch()</code> implementation (as shown in the &quot;Isomorphic Fetching&quot; example)<ul>\n<li>Before you run to get your pitchfork, hear us out! During prerendering (and only during prerendering) we patch <code>fetch()</code> to allow reading files directly from the file system. This allows you to consume static files (text, JSON, Markdown, etc.) during prerendering without having to start up a server to consume it. You can use the same file paths during prerendering as you will in the browser.</li>\n<li>In fact, that&#39;s how we build the very page you&#39;re reading! <code>fetch(&#39;/content/blog/preact-prerender.json&#39;)</code>, which is what triggers when you navigate to this page, roughly translates to <code>new Response(await fs.readFile(&#39;/content/blog/preact-prerender.json&#39;))</code> during prerendering. We read the file, wrap it in a <code>Response</code> to mimic a network request, and supply it back to your app -- your app can use the same <code>fetch()</code> request during prerendering and on the client.</li>\n<li>Pairing this with suspense and an async SSR implementation provides a really great DX.</li>\n</ul>\n</li>\n<li>Crawling Links<ul>\n<li>Partly supported by the user-provided <code>prerender()</code> function export, partly by the plugin, you can return a set of links upon prerendering the page (<code>preact-iso</code> makes this wonderfully simple) which will be added to the plugin&#39;s list of URLs to prerender. This will allow the plugin to crawl your site at build time, finding more and more pages to prerender naturally.</li>\n<li>You can also provide links manually via the plugin options or by appending some to those that <code>preact-iso</code> returns, as we show above in the Full API Example. This is especially useful for error pages, like a <code>/404</code>, that might not be linked to but you still want to have it prerendered.</li>\n</ul>\n</li>\n</ul>\n<p>...and perhaps the biggest advantage:</p>\n<ul>\n<li>Toggle it by flipping a Boolean in your config file<ul>\n<li>Because we&#39;re not a wrapper, and because you don&#39;t need to alter your source code in order to support it (beyond some window checks), there&#39;s no lock-in whatsoever. If you decide to move away, or you want to do some testing on your output, all you need to do is flip a Boolean and you&#39;re back to a plain SPA with Vite.</li>\n<li>As we&#39;ve mentioned a few times, prerendering is at its best when it is as near to &quot;drop-in&quot; as possible and that includes being able to drop back out on a whim. It&#39;s important to us that you can go from an SPA to prerendering and back again with minimal effort.</li>\n</ul>\n</li>\n</ul>\n\n\t\t\t\t<h2 id=\"final-notes\">\n\t\t\t\t\t<a class=\"fragment-link\" href=\"#final-notes\">\n\t\t\t\t\t\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" aria-label=\"Link to: Final Notes (#final-notes)\">\n\t\t\t\t\t\t\t<use href=\"/icons.svg#link\" ></use>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</a>\n\t\t\t\t\t<span>Final Notes</span>\n\t\t\t\t</h2><p>The Vite team would probably like us to mention that this plugin does introduce a tiny patch to the generated client code, and that they (the Vite team) don&#39;t necessarily endorse running the browser bundles in Node.</p>\n<p>The patch in question is as follows:</p>\n\n\t\t\t\t<div class=\"highlight-container\">\n\t\t\t\t\t<pre class=\"highlight\"><code class=\"language-diff\">// src/node/plugins/importAnalysisBuild.ts\n<span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">if (__VITE_IS_MODERN__ &amp;&amp; deps &amp;&amp; deps.length > 0) {,\n</span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">if (__VITE_IS_MODERN__ &amp;&amp; deps &amp;&amp; deps.length > 0 &amp;&amp; typeof window !== 'undefined') {,\n</span></span>\t const links = document.getElementsByTagName('link')\n\t ...</code></pre>\n\t\t\t\t\t\n\t\t\t\t</div>\n\t\t\t<p>As attempting to execute <code>document.getElementsByTagName</code> will error in Node where there is no <code>document</code>, we simply add an additional condition to the preloader so that it makes no attempt to run in Node, and that&#39;s it. Just the partial change of this one line that would little purpose during prerendering anyways.</p>\n<p>We are very, very happy with this level of risk and have been using it heavily for some time now without any issue, but, this is somewhat using the tool beyond what it was intended for and it&#39;s something we want to disclose.</p>\n<p>For any non-Preact users, good news: our plugin is entirely framework agnostic! To make it slightly easier to use in any other framework, this is alternatively offered as <a href=\"https://npm.im/vite-prerender-plugin\" target=\"_blank\" rel=\"noopener noreferrer\">`vite-prerender-plugin`</a>. Same functionality, and kept in-sync with <code>@preact/preset-vite</code>, but drops the other Preact-specific utilities that ship in the Preact preset plugin.</p>\n"}